<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://ruihan.org/courses/concurrent-prog-java/notes/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.2.1, mkdocs-material-7.1.9"><title>Concurrent Programming in Java - RUIHAN.ORG</title><link rel=stylesheet href=../../../assets/stylesheets/main.ca7ac06f.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.f1a3b89f.min.css><meta name=theme-color content=#000000><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=black> <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#concurrent-programming-in-java class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=RUIHAN.ORG class="md-header__button md-logo" aria-label=RUIHAN.ORG data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> RUIHAN.ORG </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Concurrent Programming in Java </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/iurnah/ruihan.org title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> iurnah/ruihan.org </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../books/ class=md-tabs__link> Books </a> </li> <li class=md-tabs__item> <a href=../../ class="md-tabs__link md-tabs__link--active"> Courses </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> Leetcode </a> </li> <li class=md-tabs__item> <a href=../../../research/ class=md-tabs__link> Research </a> </li> <li class=md-tabs__item> <a href=../../../seedlabs/ class=md-tabs__link> SEED Labs </a> </li> <li class=md-tabs__item> <a href=../../../system-design/ class=md-tabs__link> System Design </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=RUIHAN.ORG class="md-nav__button md-logo" aria-label=RUIHAN.ORG data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> RUIHAN.ORG </label> <div class=md-nav__source> <a href=https://github.com/iurnah/ruihan.org title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> iurnah/ruihan.org </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Books <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Books data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../books/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../../books/accelerated-cpp/notes/ class=md-nav__link> Accelerated C++ </a> </li> <li class=md-nav__item> <a href=../../../books/mining-massive-datasets/notes/ class=md-nav__link> Mining Massive Datasets </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Courses <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Courses data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Courses </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../machine-learning-coursera/notes/ class=md-nav__link> Machine Learning (Coursera) </a> </li> <li class=md-nav__item> <a href=../../cs224n/lec-notes/ class=md-nav__link> CS224N Lecture Notes </a> </li> <li class=md-nav__item> <a href=../../cs224n/write-up/ class=md-nav__link> CS224N Write-up </a> </li> <li class=md-nav__item> <a href=../../coursera-dl4-cnn/notes/ class=md-nav__link> Convolutional Neural Networks </a> </li> <li class=md-nav__item> <a href=../../mining-massive-datasets/notes/ class=md-nav__link> Mining Massive Data Sets </a> </li> <li class=md-nav__item> <a href=../../6.431-probability/notes/ class=md-nav__link> 6.431 Probability </a> </li> <li class=md-nav__item> <a href=../../learning-from-data/notes.md class=md-nav__link> Learning From Data </a> </li> <li class=md-nav__item> <a href=../../9chap-algorithms/notes/ class=md-nav__link> Nine Chapter Algorithms </a> </li> <li class=md-nav__item> <a href=../../9chap-system-design/notes/ class=md-nav__link> Nine Chapter System Design </a> </li> <li class=md-nav__item> <a href=../../9chap-dynamic-prog/notes/ class=md-nav__link> Nine Chapter Dynamic Programming </a> </li> <li class=md-nav__item> <a href=../../func-prog-in-scala/notes/ class=md-nav__link> Functional Programming Principles in Scala </a> </li> <li class=md-nav__item> <a href=../../applied-scrum-for-agile/notes/ class=md-nav__link> Applied Scrum for Agile Project Management </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Concurrent Programming in Java <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Concurrent Programming in Java </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#week-1 class=md-nav__link> Week 1 </a> <nav class=md-nav aria-label="Week 1"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-threads class=md-nav__link> 1.1 Threads </a> </li> <li class=md-nav__item> <a href=#12-structured-locks class=md-nav__link> 1.2 Structured Locks </a> </li> <li class=md-nav__item> <a href=#13-unstructured-locks class=md-nav__link> 1.3 Unstructured Locks </a> </li> <li class=md-nav__item> <a href=#14-liveness class=md-nav__link> 1.4 Liveness </a> </li> <li class=md-nav__item> <a href=#15-dining-philosophers class=md-nav__link> 1.5 Dining Philosophers </a> </li> <li class=md-nav__item> <a href=#16-mini-project class=md-nav__link> 1.6 Mini Project </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#week-2 class=md-nav__link> Week 2 </a> <nav class=md-nav aria-label="Week 2"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-critical-sections-isloated-construct class=md-nav__link> 2.1 Critical Sections (Isloated Construct) </a> </li> <li class=md-nav__item> <a href=#22-object-based-isolation-monitors class=md-nav__link> 2.2 Object Based Isolation (Monitors) </a> </li> <li class=md-nav__item> <a href=#23-concurrent-spanning-tree-algorithm class=md-nav__link> 2.3 Concurrent Spanning Tree Algorithm </a> </li> <li class=md-nav__item> <a href=#24-atomic-variables class=md-nav__link> 2.4 Atomic Variables </a> </li> <li class=md-nav__item> <a href=#25-read-write-isolation class=md-nav__link> 2.5 Read, Write Isolation </a> </li> <li class=md-nav__item> <a href=#26-mini-project class=md-nav__link> 2.6 Mini project </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#week-3 class=md-nav__link> Week 3 </a> <nav class=md-nav aria-label="Week 3"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-actors class=md-nav__link> 3.1 Actors </a> </li> <li class=md-nav__item> <a href=#32-actor-examples class=md-nav__link> 3.2 Actor Examples </a> </li> <li class=md-nav__item> <a href=#33-sieve-of-eratosthenes-algorithm class=md-nav__link> 3.3 Sieve of Eratosthenes Algorithm </a> </li> <li class=md-nav__item> <a href=#34-producer-consumer-problem class=md-nav__link> 3.4 Producer-Consumer Problem </a> </li> <li class=md-nav__item> <a href=#35-bounded-buffer-problem class=md-nav__link> 3.5 Bounded Buffer Problem </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#week-4 class=md-nav__link> Week 4 </a> <nav class=md-nav aria-label="Week 4"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#41-optimistic-concurrency class=md-nav__link> 4.1 Optimistic concurrency </a> </li> <li class=md-nav__item> <a href=#42-concurrent-queue class=md-nav__link> 4.2 Concurrent Queue </a> </li> <li class=md-nav__item> <a href=#43-linearizability class=md-nav__link> 4.3 Linearizability </a> </li> <li class=md-nav__item> <a href=#44-concurrenthashmap class=md-nav__link> 4.4 ConcurrentHashMap </a> </li> <li class=md-nav__item> <a href=#45-concurrent-minimum-spanning-tree-algorithm class=md-nav__link> 4.5 Concurrent Minimum Spanning Tree Algorithm </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../java-collections/notes/ class=md-nav__link> Java Collections </a> </li> <li class=md-nav__item> <a href=../../leadership-courses/notes/ class=md-nav__link> Leadership Courses </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Leetcode <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Leetcode data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Leetcode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../../leetcode/favorite/notes/ class=md-nav__link> Favorite </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/notes/ class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/backtracking/notes/ class=md-nav__link> Backtracking </a> </li> <li class=md-nav__item> <a href=../../../leetcode/binary-search/notes/ class=md-nav__link> Binary Search </a> </li> <li class=md-nav__item> <a href=../../../leetcode/binary-indexed-tree/notes/ class=md-nav__link> Binary Indexed Tree </a> </li> <li class=md-nav__item> <a href=../../../leetcode/breadth-first-search/notes/ class=md-nav__link> Breadth-First Search (BFS) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/depth-first-search/notes/ class=md-nav__link> Depth-First Search (DFS) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/dynamic-programming/notes/ class=md-nav__link> Dynamic Programming </a> </li> <li class=md-nav__item> <a href=../../../leetcode/graph/notes/ class=md-nav__link> Graph </a> </li> <li class=md-nav__item> <a href=../../../leetcode/heap/notes/ class=md-nav__link> Heap </a> </li> <li class=md-nav__item> <a href=../../../leetcode/interval/notes/ class=md-nav__link> Interval </a> </li> <li class=md-nav__item> <a href=../../../leetcode/linked-list/notes/ class=md-nav__link> Linked List </a> </li> <li class=md-nav__item> <a href=../../../leetcode/math/notes/ class=md-nav__link> Math </a> </li> <li class=md-nav__item> <a href=../../../leetcode/reservoir-sampling/notes/ class=md-nav__link> Reservoir Sampling </a> </li> <li class=md-nav__item> <a href=../../../leetcode/stack/notes/ class=md-nav__link> Stack </a> </li> <li class=md-nav__item> <a href=../../../leetcode/string/notes/ class=md-nav__link> String </a> </li> <li class=md-nav__item> <a href=../../../leetcode/sliding-window/notes/ class=md-nav__link> Sliding Window </a> </li> <li class=md-nav__item> <a href=../../../leetcode/topological-sort/notes/ class=md-nav__link> Topological Sort </a> </li> <li class=md-nav__item> <a href=../../../leetcode/two-pointers/notes/ class=md-nav__link> Two Pointers </a> </li> <li class=md-nav__item> <a href=../../../leetcode/tree/notes/ class=md-nav__link> Tree </a> </li> <li class=md-nav__item> <a href=../../../leetcode/trie/notes/ class=md-nav__link> Trie </a> </li> <li class=md-nav__item> <a href=../../../leetcode/union-find/notes/ class=md-nav__link> Union Find </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Research <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Research data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Research </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../research/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../../research/paper-reading/notes/ class=md-nav__link> Paper Reading </a> </li> <li class=md-nav__item> <a href=../../../research/coalition-game/notes/ class=md-nav__link> Coalition Game </a> </li> <li class=md-nav__item> <a href=../../../research/contextual-bandit/notes/ class=md-nav__link> Contextual Multi-Armed Bandit </a> </li> <li class=md-nav__item> <a href=../../../research/tfidf-score/notes/ class=md-nav__link> TF-IDF for Information Retrieval </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> SEED Labs <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SEED Labs" data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> SEED Labs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../seedlabs/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../../seedlabs/applied-crypto/notes/ class=md-nav__link> Applied Cryptograph Notes </a> </li> <li class=md-nav__item> <a href=../../../seedlabs/public-key-cryptography-and-pki/notes/ class=md-nav__link> Public Key Cryptography and PKI </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> System Design <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="System Design" data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> System Design </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../system-design/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../../system-design/browser/notes.md class=md-nav__link> How Browser Works </a> </li> <li class=md-nav__item> <a href=../../../system-design/concurrency/notes/ class=md-nav__link> Concurrency and Synchronization </a> </li> <li class=md-nav__item> <a href=../../../system-design/concepts/notes/ class=md-nav__link> Distributed System Concepts </a> </li> <li class=md-nav__item> <a href=../../../system-design/patterns/notes/ class=md-nav__link> Design Patterns </a> </li> <li class=md-nav__item> <a href=../../../system-design/problems/crawler/notes/ class=md-nav__link> Design Crawler </a> </li> <li class=md-nav__item> <a href=../../../system-design/problems/tinyurl/notes/ class=md-nav__link> Design TinyUrl </a> </li> <li class=md-nav__item> <a href=../../../system-design/problems/twitter/notes/ class=md-nav__link> Design Twitter </a> </li> <li class=md-nav__item> <a href=../../../system-design/problems/scheduler/notes/ class=md-nav__link> Deisgn Scheduler </a> </li> <li class=md-nav__item> <a href=../../../system-design/problems/ticketmaster/notes/ class=md-nav__link> Design Ticketmaster </a> </li> <li class=md-nav__item> <a href=../../../system-design/problems/messager/notes/ class=md-nav__link> Design Messager </a> </li> <li class=md-nav__item> <a href=../../../system-design/problems/payment/notes/ class=md-nav__link> Design Payment System </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#week-1 class=md-nav__link> Week 1 </a> <nav class=md-nav aria-label="Week 1"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-threads class=md-nav__link> 1.1 Threads </a> </li> <li class=md-nav__item> <a href=#12-structured-locks class=md-nav__link> 1.2 Structured Locks </a> </li> <li class=md-nav__item> <a href=#13-unstructured-locks class=md-nav__link> 1.3 Unstructured Locks </a> </li> <li class=md-nav__item> <a href=#14-liveness class=md-nav__link> 1.4 Liveness </a> </li> <li class=md-nav__item> <a href=#15-dining-philosophers class=md-nav__link> 1.5 Dining Philosophers </a> </li> <li class=md-nav__item> <a href=#16-mini-project class=md-nav__link> 1.6 Mini Project </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#week-2 class=md-nav__link> Week 2 </a> <nav class=md-nav aria-label="Week 2"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-critical-sections-isloated-construct class=md-nav__link> 2.1 Critical Sections (Isloated Construct) </a> </li> <li class=md-nav__item> <a href=#22-object-based-isolation-monitors class=md-nav__link> 2.2 Object Based Isolation (Monitors) </a> </li> <li class=md-nav__item> <a href=#23-concurrent-spanning-tree-algorithm class=md-nav__link> 2.3 Concurrent Spanning Tree Algorithm </a> </li> <li class=md-nav__item> <a href=#24-atomic-variables class=md-nav__link> 2.4 Atomic Variables </a> </li> <li class=md-nav__item> <a href=#25-read-write-isolation class=md-nav__link> 2.5 Read, Write Isolation </a> </li> <li class=md-nav__item> <a href=#26-mini-project class=md-nav__link> 2.6 Mini project </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#week-3 class=md-nav__link> Week 3 </a> <nav class=md-nav aria-label="Week 3"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-actors class=md-nav__link> 3.1 Actors </a> </li> <li class=md-nav__item> <a href=#32-actor-examples class=md-nav__link> 3.2 Actor Examples </a> </li> <li class=md-nav__item> <a href=#33-sieve-of-eratosthenes-algorithm class=md-nav__link> 3.3 Sieve of Eratosthenes Algorithm </a> </li> <li class=md-nav__item> <a href=#34-producer-consumer-problem class=md-nav__link> 3.4 Producer-Consumer Problem </a> </li> <li class=md-nav__item> <a href=#35-bounded-buffer-problem class=md-nav__link> 3.5 Bounded Buffer Problem </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#week-4 class=md-nav__link> Week 4 </a> <nav class=md-nav aria-label="Week 4"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#41-optimistic-concurrency class=md-nav__link> 4.1 Optimistic concurrency </a> </li> <li class=md-nav__item> <a href=#42-concurrent-queue class=md-nav__link> 4.2 Concurrent Queue </a> </li> <li class=md-nav__item> <a href=#43-linearizability class=md-nav__link> 4.3 Linearizability </a> </li> <li class=md-nav__item> <a href=#44-concurrenthashmap class=md-nav__link> 4.4 ConcurrentHashMap </a> </li> <li class=md-nav__item> <a href=#45-concurrent-minimum-spanning-tree-algorithm class=md-nav__link> 4.5 Concurrent Minimum Spanning Tree Algorithm </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=concurrent-programming-in-java>Concurrent Programming in Java<a class=headerlink href=#concurrent-programming-in-java title="Permanent link">&para;</a></h1> <p>parallelStream() fork/join conditional variable</p> <h2 id=week-1>Week 1<a class=headerlink href=#week-1 title="Permanent link">&para;</a></h2> <h3 id=11-threads>1.1 Threads<a class=headerlink href=#11-threads title="Permanent link">&para;</a></h3> <div class=tabbed-set data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><label for=__tabbed_1_1>Thread Example</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// main thread T0</span>
<span class=n>t1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=p>(</span><span class=n>s1</span><span class=p>);</span> <span class=c1>// s1 is the computation assign val x</span>
<span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>          <span class=c1>// start thread t1 by main thread t0</span>
<span class=n>s2</span><span class=p>;</span>                  <span class=c1>// execute computation task by t0</span>
<span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span>           <span class=c1>// wait the val x computation from t1 for use in s3</span>
<span class=n>s3</span><span class=p>;</span>                  <span class=c1>// computation read val x</span>
</code></pre></div> </div> <input id=__tabbed_1_2 name=__tabbed_1 type=radio><label for=__tabbed_1_2>Deadlock</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// If s1 have t2.join() and s1` have t1.join(), deadlock will happen</span>
<span class=c1>// main thread T0</span>
<span class=n>t1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=p>(</span><span class=n>s1</span><span class=p>);</span>   <span class=c1>// s1 is the computation assign val x</span>
<span class=n>t2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=p>(</span><span class=n>s1</span><span class=err>`</span><span class=p>);</span>  <span class=c1>// s1` is the computation assign val x</span>
<span class=n>t1</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>            <span class=c1>// start thread t1 by main thread t0</span>
<span class=n>t2</span><span class=p>.</span><span class=na>start</span><span class=p>()</span>             <span class=c1>// start thread t2 by main thread t0</span>
<span class=n>s2</span><span class=p>;</span>                    <span class=c1>// execute computation task by t0</span>
<span class=n>t1</span><span class=p>.</span><span class=na>join</span><span class=p>();</span>             <span class=c1>// wait the val x computation from t1 for use in s3</span>
<span class=n>s3</span><span class=p>;</span>                    <span class=c1>// computation read val x</span>
</code></pre></div> </div> </div> <p>1.1 Lecture Summary</p> <p>In this lecture, we learned the concept of threads as lower-level building blocks for concurrent programs. A unique aspect of Java compared to prior mainstream programming languages is that Java included the notions of threads (as instances of the <code>java.lang.Thread</code> class in its language definition right from the start.</p> <p>When an instance of <code>Thread</code> is created (via a <code>new</code> operation), it does not start executing right away; instead, it can only start executing when its <code>start()</code> method is invoked. The statement or computation to be executed by the thread is specified as a parameter to the constructor.</p> <p>The Thread class also includes a wait operation in the form of a <code>join()</code> method. If thread <code>t0</code> performs a <code>t1.join()</code> call, thread <code>t0</code> will be forced to wait until thread <code>t1</code> completes, after which point it can safely access any values computed by thread <code>t1</code>. Since there is no restriction on which thread can perform a <code>join</code> on which other thread, it is possible for a programmer to erroneously create a deadlock cycle with <code>join</code> operations. (A deadlock occurs when two threads wait for each other indefinitely, so that neither can make any progress.)</p> <p>1.1 Optional Reading</p> <ol> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Thread_(computing)>Threads</a></li> <li><a href=https://docs.oracle.com/javase/tutorial/essential/concurrency/runthread.html>Tutorial on Java threads</a></li> <li><a href=https://docs.oracle.com/javase/8/docs/api/java/lang/Thread.html>Documentation on Thread class in Java 8</a></li> </ol> <h3 id=12-structured-locks>1.2 Structured Locks<a class=headerlink href=#12-structured-locks title="Permanent link">&para;</a></h3> <div class=tabbed-set data-tabs=2:3><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><label for=__tabbed_2_1>Synchronized</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=n>incr</span><span class=p>(</span><span class=n>A</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>A</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>A</span><span class=p>.</span><span class=na>count</span> <span class=o>=</span> <span class=n>A</span><span class=p>.</span><span class=na>count</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span> <span class=c1>// release A</span>
<span class=p>}</span>
</code></pre></div> </div> <input id=__tabbed_2_2 name=__tabbed_2 type=radio><label for=__tabbed_2_2>Unbounded Buffer</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// x = {BUF, IN, OUT}</span>
<span class=n>insert</span><span class=p>(</span><span class=n>item</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>buf</span><span class=o>[</span><span class=n>in</span><span class=o>]</span> <span class=o>=</span> <span class=n>item</span><span class=p>;</span>
    <span class=n>in</span><span class=o>++</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=n>remove</span><span class=p>()</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>item</span> <span class=o>=</span> <span class=n>buf</span><span class=o>[</span><span class=n>out</span><span class=o>]</span><span class=p>;</span>
    <span class=n>out</span><span class=o>++</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>item</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> </div> <input id=__tabbed_2_3 name=__tabbed_2 type=radio><label for=__tabbed_2_3>Bounded Buffer</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// x = {BUF, IN, OUT} with size K</span>
<span class=n>insert</span><span class=p>(</span><span class=n>item</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>wait</span><span class=p>();</span> <span class=c1>// wait if x is full</span>
    <span class=n>buf</span><span class=o>[</span><span class=n>in</span><span class=o>]</span> <span class=o>=</span> <span class=n>item</span><span class=p>;</span>
    <span class=n>in</span><span class=o>++</span><span class=p>;</span>
    <span class=n>notify</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=n>remove</span><span class=p>()</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>wait</span><span class=p>();</span> <span class=c1>// wait if x is empty</span>
    <span class=n>item</span> <span class=o>=</span> <span class=n>buf</span><span class=o>[</span><span class=n>out</span><span class=o>]</span><span class=p>;</span>
    <span class=n>out</span><span class=o>++</span><span class=p>;</span>
    <span class=n>notify</span><span class=p>();</span>
    <span class=k>return</span> <span class=n>item</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> </div> </div> <p>1.2 Lecture Summary</p> <p>In this lecture, we learned about structured locks, and how they can be implemented using <code>synchronized</code> statements and methods in Java. Structured locks can be used to enforce mutual exclusion and avoid data races, as illustrated by the <code>incr()</code> method in the <code>A.count</code> example, and the <code>insert()</code> and <code>remove()</code> methods in the the <code>Buffer</code> example. A major benefit of structured locks is that their acquire and release operations are implicit, since these operations are automatically performed by the Java runtime environment when entering and exiting the scope of a <code>synchronized</code> statement or method, even if an exception is thrown in the middle.</p> <p>We also learned about <code>wait()</code> and <code>notify()</code> operations that can be used to block and resume threads that need to wait for specific conditions. For example, a producer thread performing an <code>insert()</code> operation on a bounded buffer can call <code>wait()</code> when the buffer is full, so that it is only unblocked when a consumer thread performing a <code>remove()</code> operation calls <code>notify()</code>. Likewise, a consumer thread performing a <code>remove()</code> operation on a bounded buffer can call <code>wait()</code> when the buffer is empty, so that it is only unblocked when a producer thread performing an <code>insert()</code> operation calls <code>notify()</code>. Structured locks are also referred to as intrinsic locks or monitors.</p> <p>1.2 Optional Reading</p> <ol> <li><a href=https://docs.oracle.com/javase/tutorial/essential/concurrency/locksync.html>Tutorial on Intrinsic Locks and Synchronization in Java</a></li> <li><a href=https://docs.oracle.com/javase/tutorial/essential/concurrency/guardmeth.html>Tutorial on Guarded Blocks in Java</a></li> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Monitor_(synchronization)>Monitors</a></li> </ol> <h3 id=13-unstructured-locks>1.3 Unstructured Locks<a class=headerlink href=#13-unstructured-locks title="Permanent link">&para;</a></h3> <div class=tabbed-set data-tabs=3:3><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><label for=__tabbed_3_1>Hand-over-hand lock</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// LinkedList: N1-&gt;N2-&gt;N3-&gt;N4</span>
<span class=c1>// Lock4Nodes: L1  L2  L3  L4</span>
<span class=n>lock</span><span class=p>(</span><span class=n>L1</span><span class=p>);</span>
<span class=n>lock</span><span class=p>(</span><span class=n>L2</span><span class=p>);</span>
<span class=n>WORK</span> <span class=n>with</span> <span class=n>N1</span><span class=p>,</span> <span class=n>N2</span>
<span class=nf>unlock</span><span class=p>(</span><span class=n>L1</span><span class=p>);</span>
<span class=n>lock</span><span class=p>(</span><span class=n>L3</span><span class=p>);</span>
<span class=n>WORK</span> <span class=n>with</span> <span class=n>N2</span><span class=p>,</span> <span class=n>N3</span>
<span class=nf>unlock</span><span class=p>(</span><span class=n>L2</span><span class=p>);</span>
<span class=n>lock</span><span class=p>(</span><span class=n>L4</span><span class=p>);</span>
<span class=n>WORK</span> <span class=n>with</span> <span class=n>N3</span><span class=p>,</span> <span class=n>N4</span>
<span class=nf>unlock</span><span class=p>(</span><span class=n>L3</span><span class=p>);</span>
</code></pre></div> </div> <input id=__tabbed_3_2 name=__tabbed_3 type=radio><label for=__tabbed_3_2>Hand-over-hand lock using try_lock</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// LinkedList: N1-&gt;N2-&gt;N3-&gt;N4</span>
<span class=c1>// Lock4Nodes: L1  L2  L3  L4</span>
<span class=k>try</span>
  <span class=n>lock</span><span class=p>(</span><span class=n>L1</span><span class=p>);</span>
<span class=k>if</span> <span class=p>(</span><span class=n>success</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>lock</span><span class=p>(</span><span class=n>L2</span><span class=p>);</span>
  <span class=n>WORK</span> <span class=n>with</span> <span class=n>N1</span><span class=p>,</span> <span class=n>N2</span>
  <span class=nf>unlock</span><span class=p>(</span><span class=n>L1</span><span class=p>);</span>
  <span class=n>lock</span><span class=p>(</span><span class=n>L3</span><span class=p>);</span>
  <span class=n>WORK</span> <span class=n>with</span> <span class=n>N2</span><span class=p>,</span> <span class=n>N3</span>
  <span class=nf>unlock</span><span class=p>(</span><span class=n>L2</span><span class=p>);</span>
  <span class=n>lock</span><span class=p>(</span><span class=n>L4</span><span class=p>);</span>
  <span class=n>WORK</span> <span class=n>with</span> <span class=n>N3</span><span class=p>,</span> <span class=n>N4</span>
  <span class=nf>unlock</span><span class=p>(</span><span class=n>L3</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> </div> <input id=__tabbed_3_3 name=__tabbed_3 type=radio><label for=__tabbed_3_3>R/W lock</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// data: Array[]</span>
<span class=c1>// R/W lock: L</span>
<span class=n>search</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>read_lock</span><span class=p>(</span><span class=n>L</span><span class=p>)</span>
  <span class=n>A</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>==</span> <span class=n>x</span><span class=p>;</span>  <span class=c1>// read only</span>
  <span class=n>unlock</span><span class=p>(</span><span class=n>L</span><span class=p>)</span>
<span class=p>}</span>

<span class=n>update</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>write_lock</span><span class=p>(</span><span class=n>L</span><span class=p>)</span>
  <span class=n>A</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>y</span><span class=p>;</span>   <span class=c1>// write</span>
  <span class=n>unlock</span><span class=p>(</span><span class=n>L</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div> </div> </div> <p>1.3 Lecture Summary</p> <p>In this lecture, we introduced unstructured locks (which can be obtained in Java by creating instances of <code>ReentrantLock()</code>, and used three examples to demonstrate their generality relative to structured locks. The first example showed how explicit <code>lock()</code> and <code>unlock()</code> operations on unstructured locks can be used to support a hand-over-hand locking pattern that implements a non-nested pairing of lock/unlock operations which cannot be achieved with synchronized statements/methods. The second example showed how the <code>tryLock()</code> operations in unstructured locks can enable a thread to check the availability of a lock, and thereby acquire it if it is available or do something else if it is not. The third example illustrated the value of read-write locks (which can be obtained in Java by creating instances of <code>ReentrantReadWriteLock()</code>, whereby multiple threads are permitted to acquire a lock <code>L</code> in "read mode", <code>L.readLock().lock()</code>, but only one thread is permitted to acquire the lock in “write mode”, <code>L.writeLock().lock()</code>.</p> <p>However, it is also important to remember that the generality and power of unstructured locks is accompanied by an extra responsibility on the part of the programmer, e.g., ensuring that calls to <code>unlock()</code> are not forgotten, even in the presence of exceptions.</p> <p>1.3 Optional Reading</p> <ol> <li><a href=https://docs.oracle.com/javase/tutorial/essential/concurrency/newlocks.html>Tutorial on Lock Objects in Java</a></li> <li><a href=http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/locks/Lock.html>Documentation on Java’s Lock interfaces</a></li> </ol> <h3 id=14-liveness>1.4 Liveness<a class=headerlink href=#14-liveness title="Permanent link">&para;</a></h3> <div class=tabbed-set data-tabs=4:3><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><label for=__tabbed_4_1>Deadlock</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// T1</span>
<span class=kd>synchronized</span> <span class=p>(</span><span class=n>A</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>B</span><span class=p>)</span> <span class=p>{</span>
  <span class=p>}</span>
<span class=p>}</span>
<span class=c1>// T2</span>
<span class=kd>synchronized</span> <span class=p>(</span><span class=n>B</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>A</span><span class=p>)</span> <span class=p>{</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> </div> <input id=__tabbed_4_2 name=__tabbed_4 type=radio><label for=__tabbed_4_2>Livelock</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// T1</span>
<span class=k>do</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>B</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>x</span><span class=p>.</span><span class=na>incr</span><span class=p>();</span>
    <span class=n>r</span> <span class=o>=</span> <span class=n>x</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>R</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)</span>
<span class=c1>// T2</span>
<span class=k>do</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>B</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>x</span><span class=p>.</span><span class=na>decr</span><span class=p>();</span>
    <span class=n>r</span> <span class=o>=</span> <span class=n>x</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>R</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>2</span><span class=p>)</span>
</code></pre></div> </div> <input id=__tabbed_4_3 name=__tabbed_4 type=radio><label for=__tabbed_4_3>Starvation</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// T1</span>
<span class=k>do</span> <span class=p>{</span>
  <span class=n>int1</span> <span class=o>=</span> <span class=n>s1</span><span class=p>.</span><span class=na>readline</span><span class=p>();</span>
  <span class=n>print</span> <span class=n>int1</span><span class=p>;</span>
<span class=p>}</span> <span class=k>while</span> <span class=p>(...)</span>
<span class=c1>// ...</span>
<span class=c1>// T100</span>
<span class=k>do</span> <span class=p>{</span>
  <span class=n>int100</span> <span class=o>=</span> <span class=n>s100</span><span class=p>.</span><span class=na>readline</span><span class=p>();</span>
  <span class=n>print</span> <span class=n>int100</span><span class=p>;</span>
<span class=p>}</span> <span class=k>while</span> <span class=p>(...)</span>
</code></pre></div> </div> </div> <p>1.4 Lecture Summary</p> <p>In this lecture, we studied three ways in which a parallel program may enter a state in which it stops making forward progress. For sequential programs, an "infinite loop" is a common way for a program to stop making forward progress, but there are other ways to obtain an absence of progress in a parallel program. The first is <strong>deadlock</strong>, in which all threads are blocked indefinitely, thereby preventing any forward progress. The second is <strong>livelock</strong>, in which all threads repeatedly perform an interaction that prevents forward progress, e.g., an infinite “loop” of repeating lock acquire/release patterns. The third is <strong>starvation</strong>, in which at least one thread is prevented from making any forward progress.</p> <p>The term "liveness" refers to a progress guarantee. The three progress guarantees that correspond to the absence of the conditions listed above are deadlock freedom, livelock freedom, and starvation freedom.</p> <p>1.4 Optional Reading</p> <ol> <li><a href=https://docs.oracle.com/javase/tutorial/essential/concurrency/deadlock.html>Deadlock example with synchronized methods in Java</a></li> <li><a href=https://docs.oracle.com/javase/tutorial/essential/concurrency/starvelive.html>Starvation and Livelock examples in Java</a></li> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Deadlock>Deadlock and Livelock</a></li> </ol> <h3 id=15-dining-philosophers>1.5 Dining Philosophers<a class=headerlink href=#15-dining-philosophers title="Permanent link">&para;</a></h3> <ul> <li>think</li> <li>pick up chopsticks (left, right)</li> <li>eat</li> <li>put down chopsticks</li> </ul> <div class=tabbed-set data-tabs=5:3><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><label for=__tabbed_5_1>Structured locks</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// if all pick up the left first, deadlock</span>
<span class=k>while</span> <span class=p>(...)</span> <span class=p>{</span>
  <span class=n>Think</span><span class=p>;</span>
  <span class=n>sychronized</span> <span class=p>(</span><span class=n>Left</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>sychronized</span> <span class=p>(</span><span class=n>Right</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>Eat</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> </div> <input id=__tabbed_5_2 name=__tabbed_5 type=radio><label for=__tabbed_5_2>unstructured locks</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// if all pick up the left first, livelock, but no deadlock</span>
<span class=k>while</span> <span class=p>(...)</span> <span class=p>{</span>
  <span class=n>Think</span><span class=p>;</span>
  <span class=n>s1</span> <span class=o>=</span> <span class=n>tryLock</span><span class=p>(</span><span class=n>Left</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>s1</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
  <span class=n>s2</span> <span class=o>=</span> <span class=n>tryLock</span><span class=p>(</span><span class=n>Right</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>s2</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>unlock</span><span class=p>(</span><span class=n>Left</span><span class=p>);</span>
    <span class=k>continue</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>Eat</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> </div> <input id=__tabbed_5_3 name=__tabbed_5 type=radio><label for=__tabbed_5_3>Modified version</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// have one of the philosophers pick right first and then left.</span>
<span class=c1>// However, this can also cause the starvation problem. To solve</span>
<span class=c1>// the problem completely, we need to use another synchronization</span>
<span class=c1>// premitive called semaphore.</span>
</code></pre></div> </div> </div> <p>1.5 Lecture Summary</p> <p>In this lecture, we studied a classical concurrent programming example that is referred to as the <strong>Dining Philosophers Problem</strong>. In this problem, there are five threads, each of which models a "philosopher" that repeatedly performs a sequence of actions which include think, pick up chopsticks, eat, and put down chopsticks.</p> <p>First, we examined a solution to this problem using structured locks, and demonstrated how this solution could lead to a deadlock scenario (but not livelock). Second, we examined a solution using unstructured locks with <code>tryLock()</code> and <code>unlock()</code> operations that never block, and demonstrated how this solution could lead to a livelock scenario (but not deadlock). Finally, we observed how a simple modification to the first solution with structured locks, in which one philosopher picks up their right chopstick and their left, while the others pick up their left chopstick first and then their right, can guarantee an absence of deadlock.</p> <p>1.5 Optional Reading</p> <ol> <li>Wikipedia article on the <a href=https://en.wikipedia.org/wiki/Dining_philosophers_problem>Dining Philosophers Problem</a></li> </ol> <h3 id=16-mini-project>1.6 Mini Project<a class=headerlink href=#16-mini-project title="Permanent link">&para;</a></h3> <p>The mini project used Java <code>ReentrantLock</code> and <code>ReentrantReadWriteLock</code> to ensure the list operations are free of bugs if run by multiple threads. One practical tip is that when using the basic lock primitive the lock statement can be put in the <code>try</code> and unlock in the <code>finally</code> statement, respectively.</p> <h2 id=week-2>Week 2<a class=headerlink href=#week-2 title="Permanent link">&para;</a></h2> <h3 id=21-critical-sections-isloated-construct>2.1 Critical Sections (Isloated Construct)<a class=headerlink href=#21-critical-sections-isloated-construct title="Permanent link">&para;</a></h3> <div class=tabbed-set data-tabs=6:2><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><label for=__tabbed_6_1>Balance Transfer</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// My balance:       5000</span>
<span class=c1>// Family balance:   1000</span>
<span class=c1>// Daughter balance: 0</span>
<span class=n>T1</span> <span class=p>{</span>
  <span class=n>myBal</span> <span class=o>=</span> <span class=n>myBal</span> <span class=o>-</span> <span class=mi>100</span><span class=p>;</span>         <span class=c1>// R1</span>
  <span class=n>familyBal</span> <span class=o>=</span> <span class=n>familyBal</span> <span class=o>+</span> <span class=mi>100</span><span class=p>;</span> <span class=c1>// W1</span>
<span class=p>}</span>

<span class=n>T2</span> <span class=p>{</span>
  <span class=n>familyBal</span> <span class=o>=</span> <span class=n>familyBal</span> <span class=o>-</span> <span class=mi>100</span><span class=p>;</span> <span class=c1>// R2</span>
  <span class=n>DauBal</span> <span class=o>=</span> <span class=n>DarBal</span> <span class=o>+</span> <span class=mi>100</span><span class=p>;</span>       <span class=c1>// W2</span>
<span class=p>}</span>
</code></pre></div> </div> <input id=__tabbed_6_2 name=__tabbed_6 type=radio><label for=__tabbed_6_2>Use isolated</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// My balance:       5000</span>
<span class=c1>// Family balance:   1000</span>
<span class=c1>// Daughter balance: 0</span>
<span class=n>T1</span> <span class=p>{</span>
  <span class=n>isolated</span> <span class=p>{</span>
    <span class=n>myBal</span> <span class=o>=</span> <span class=n>myBal</span> <span class=o>-</span> <span class=mi>100</span><span class=p>;</span>         <span class=c1>// R1</span>
    <span class=n>familyBal</span> <span class=o>=</span> <span class=n>familyBal</span> <span class=o>+</span> <span class=mi>100</span><span class=p>;</span> <span class=c1>// W1</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=n>T2</span> <span class=p>{</span>
  <span class=n>isolated</span> <span class=p>{</span>
    <span class=n>familyBal</span> <span class=o>=</span> <span class=n>familyBal</span> <span class=o>-</span> <span class=mi>100</span><span class=p>;</span> <span class=c1>// R2</span>
    <span class=n>DauBal</span> <span class=o>=</span> <span class=n>DarBal</span> <span class=o>+</span> <span class=mi>100</span><span class=p>;</span>       <span class=c1>// W2</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> </div> </div> <p>2.1 Lecture Summary</p> <p>In this lecture, we learned how critical sections and the isolated construct can help concurrent threads manage their accesses to shared resources, at a higher level than just using locks. When programming with threads, it is well known that the following situation is defined to be a data race error — when two accesses on the same shared location can potentially execute in parallel, with least one access being a write. However, there are many cases in practice when two tasks may legitimately need to perform concurrent accesses to shared locations, as in the bank transfer example.</p> <p>With critical sections, two blocks of code that are marked as isolated, say <code>A</code> and <code>B</code>, are guaranteed to be executed in mutual exclusion with <code>A</code> executing before <code>B</code> or vice versa. With the use of isolated constructs, it is impossible for the bank transfer example to end up in an inconsistent state because all the reads and writes for one isolated section must complete before the start of another isolated construct. Thus, the parallel program will see the effect of one isolated section completed before another isolated section can start.</p> <p>2.1 Optional Reading</p> <ol> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Critical_section>Critical Sections</a></li> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Atomicity_(database_systems)>Atomicity</a></li> </ol> <h3 id=22-object-based-isolation-monitors>2.2 Object Based Isolation (Monitors)<a class=headerlink href=#22-object-based-isolation-monitors title="Permanent link">&para;</a></h3> <div class=tabbed-set data-tabs=7:3><input checked=checked id=__tabbed_7_1 name=__tabbed_7 type=radio><label for=__tabbed_7_1>DoubleLinkedList Example</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// A &lt;-&gt; B &lt;-&gt; C &lt;-&gt; D &lt;-&gt; E</span>
<span class=n>delete</span><span class=p>(</span><span class=n>cur</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>cur</span><span class=p>.</span><span class=na>prev</span><span class=p>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>cur</span><span class=p>.</span><span class=na>next</span><span class=p>;</span>
  <span class=n>cur</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>prev</span> <span class=o>=</span> <span class=n>cur</span><span class=p>.</span><span class=na>prev</span><span class=p>;</span>
<span class=p>}</span>
<span class=c1>// T1: Delete(B)</span>
<span class=c1>// T2: Delete(C)</span>
<span class=c1>// T3: Delete(E)</span>
</code></pre></div> </div> <input id=__tabbed_7_2 name=__tabbed_7 type=radio><label for=__tabbed_7_2>DoubleLinkedList using isolated</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// A &lt;-&gt; B &lt;-&gt; C &lt;-&gt; D &lt;-&gt; E</span>
<span class=n>delete</span><span class=p>(</span><span class=n>cur</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>isolated</span> <span class=p>(</span><span class=n>cur</span><span class=p>,</span> <span class=n>cur</span><span class=p>.</span><span class=na>prev</span><span class=p>,</span> <span class=n>cur</span><span class=p>.</span><span class=na>next</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>cur</span><span class=p>.</span><span class=na>prev</span><span class=p>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>cur</span><span class=p>.</span><span class=na>next</span><span class=p>;</span>
    <span class=n>cur</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>prev</span> <span class=o>=</span> <span class=n>cur</span><span class=p>.</span><span class=na>prev</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
<span class=c1>// T1: Delete(B) touch (A, B, C)</span>
<span class=c1>// T2: Delete(C) touch (B, C, D)</span>
<span class=c1>// T3: Delete(E) touch (D, E, F)</span>
<span class=c1>// T1 and T3 can be done in the same time.</span>
</code></pre></div> </div> <input id=__tabbed_7_3 name=__tabbed_7 type=radio><label for=__tabbed_7_3>Monitor intuition</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// P1, process 1</span>
<span class=c1>// P2, process 2</span>
<span class=n>Isolated</span><span class=p>(</span><span class=n>M1</span><span class=p>)</span>
<span class=n>M1</span> <span class=p>{</span>
  <span class=n>P1</span><span class=p>:</span> <span class=n>Isolated</span><span class=p>(</span><span class=n>M1</span><span class=p>);</span>
  <span class=n>P2</span><span class=p>:</span> <span class=n>Isolated</span><span class=p>(</span><span class=n>M1</span><span class=p>);</span>
<span class=p>}</span>
<span class=n>M2</span> <span class=p>{</span>
  <span class=n>P1</span><span class=p>:</span> <span class=n>Isolated</span><span class=p>(</span><span class=n>M2</span><span class=p>);</span>
  <span class=n>P2</span><span class=p>:</span> <span class=n>Isolated</span><span class=p>(</span><span class=n>M2</span><span class=p>);</span>
<span class=p>}</span>
<span class=n>Isolated</span><span class=p>(</span><span class=n>M2</span><span class=p>)</span>
</code></pre></div> </div> </div> <p>2.2 Lecture Summary</p> <p>In this lecture, we studied object-based isolation, which generalizes the isolated construct and relates to the classical concept of monitors. The fundamental idea behind object-based isolation is that an isolated construct can be extended with a set of objects that indicate the scope of isolation, by using the following rules: if two isolated constructs have an empty intersection in their object sets they can execute in parallel, otherwise they must execute in mutual exclusion. We observed that implementing this capability can be very challenging with locks because a correct implementation must enforce the correct levels of mutual exclusion without entering into deadlock or livelock states. The linked-list example showed how the object set for a <code>delete()</code> method can be defined as consisting of three objects — the current, previous, and next objects in the list, and that this object set is sufficient to safely enable parallelism across multiple calls to <code>delete()</code>. The Java code sketch to achieve this object-based isolation using the PCDP library is as follows:</p> <div class=highlight><pre><span></span><code><span class=n>isolated</span><span class=p>(</span><span class=n>cur</span><span class=p>,</span> <span class=n>cur</span><span class=p>.</span><span class=na>prev</span><span class=p>,</span> <span class=n>cur</span><span class=p>.</span><span class=na>next</span><span class=p>,</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=p>{</span>
    <span class=p>.</span> <span class=p>.</span> <span class=p>.</span> <span class=c1>// Body of object-based isolated construct</span>
<span class=p>});</span>
</code></pre></div> <p>The relationship between object-based isolation and monitors is that all methods in a monitor object, <code>M1</code>, are executed as object-based isolated constructs with a singleton object set, <code>M1</code>. Similarly, all methods in a monitor object, <code>M2</code>, are executed as object-based isolated constructs with a singleton object set, <code>M2</code> which has an empty intersection with <code>M1</code>.</p> <p>2.2 Optional Reading</p> <ol> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Monitor_(synchronization)>Monitors</a></li> </ol> <h3 id=23-concurrent-spanning-tree-algorithm>2.3 Concurrent Spanning Tree Algorithm<a class=headerlink href=#23-concurrent-spanning-tree-algorithm title="Permanent link">&para;</a></h3> <div class=tabbed-set data-tabs=8:2><input checked=checked id=__tabbed_8_1 name=__tabbed_8 type=radio><label for=__tabbed_8_1>Spanning Tree Algorithm</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=n>Compute</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>for</span> <span class=n>each</span> <span class=n>neighbor</span> <span class=n>c</span> <span class=n>of</span> <span class=n>v</span>
    <span class=n>s</span> <span class=o>&lt;-</span> <span class=n>MakeParent</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=p>)</span>
      <span class=n>Compute</span><span class=p>(</span><span class=n>c</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>MakeParent</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>c</span><span class=p>.</span><span class=na>parent</span> <span class=o>==</span> <span class=n>Null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>c</span><span class=p>.</span><span class=na>parent</span> <span class=o>=</span> <span class=n>v</span><span class=p>;</span>
    <span class=n>success</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>success</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>success</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> </div> <input id=__tabbed_8_2 name=__tabbed_8 type=radio><label for=__tabbed_8_2>Isolation Construct</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=n>Compute</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>for</span> <span class=n>each</span> <span class=n>neighbor</span> <span class=n>c</span> <span class=n>of</span> <span class=n>v</span>
    <span class=n>s</span> <span class=o>&lt;-</span> <span class=n>MakeParent</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=p>)</span>
      <span class=n>Compute</span><span class=p>(</span><span class=n>c</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>MakeParent</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>isolated</span><span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>c</span><span class=p>.</span><span class=na>parent</span> <span class=o>==</span> <span class=n>Null</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// compare-and-set premitive</span>
      <span class=n>c</span><span class=p>.</span><span class=na>parent</span> <span class=o>=</span> <span class=n>v</span><span class=p>;</span>
      <span class=n>success</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>success</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
      <span class=k>return</span> <span class=n>success</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> </div> </div> <p>2.3 Lecture Summary</p> <p>In this lecture, we learned how to use object-based isolation to create a parallel algorithm to compute spanning trees for an undirected graph. Recall that a spanning tree specifies a subset of edges in the graph that form a tree (no cycles), and connect all vertices in the graph. A standard recursive method for creating a spanning tree is to perform a depth-first traversal of the graph (the <code>Compute(v)</code> function in our example), making the current vertex a parent of all its neighbors that don’t already have a parent assigned in the tree (the <code>MakeParent(v, c)</code> function in the example).</p> <p>The approach described in this lecture to parallelize the spanning tree computation executes recursive <code>Compute(c)</code> method calls in parallel for all neighbors, <code>c</code>, of the current vertex, <code>v</code>. Object-based isolation helps avoid a data race in the <code>MakeParent(v,c)</code> method, when two parallel threads might attempt to call <code>MakeParent(v1, c)</code> and <code>MakeParent(v2, c)</code> on the same vertex <code>c</code> at the same time. In this example, the role of object-based isolation is to ensure that all calls to <code>MakeParent(v,c)</code> with the same <code>c</code> value must execute the object-based isolated statement in mutual exclusion, whereas calls with different values of <code>c</code> can proceed in parallel.</p> <p>2.3 Optional Reading</p> <ol> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Spanning_tree>Spanning Trees</a></li> </ol> <h3 id=24-atomic-variables>2.4 Atomic Variables<a class=headerlink href=#24-atomic-variables title="Permanent link">&para;</a></h3> <div class=tabbed-set data-tabs=9:2><input checked=checked id=__tabbed_9_1 name=__tabbed_9 type=radio><label for=__tabbed_9_1>Atomic Variables (Integer)</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// X[0, ... N-1]</span>
<span class=k>do</span> <span class=p>{</span>
  <span class=n>j</span> <span class=o>=</span> <span class=n>curr</span><span class=p>;</span>       <span class=c1>// curr.getAndAdd(1); atomic integer!!!.</span>
  <span class=n>cur</span> <span class=o>=</span> <span class=n>cur</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=o>&gt;=</span> <span class=n>N</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
  <span class=n>process</span><span class=p>(</span><span class=n>X</span><span class=o>[</span><span class=n>j</span><span class=o>]</span><span class=p>)</span>
<span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</code></pre></div> </div> <input id=__tabbed_9_2 name=__tabbed_9 type=radio><label for=__tabbed_9_2>Atomic Reference (compareAndSet)</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=n>compareAndSet</span><span class=p>(</span><span class=n>expected</span><span class=p>,</span> <span class=k>new</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>isolated</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>val</span> <span class=o>==</span> <span class=n>expected</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>this</span><span class=p>.</span><span class=na>val</span> <span class=o>=</span> <span class=k>new</span><span class=p>;</span>
      <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> </div> </div> <p>2.4 Lecture Summary</p> <p>In this lecture, we studied <strong>Atomic Variables</strong>, an important special case of object-based isolation which can be very efficiently implemented on modern computer systems. In the example given in the lecture, we have multiple threads processing an array, each using object-based isolation to safely increment a shared object, <code>cur</code>, to compute an index <code>j</code> which can then be used by the thread to access a thread-specific element of the array.</p> <p>However, instead of using object-based isolation, we can declare the index <code>cur</code> to be an <strong>Atomic Integer</strong> variable and use an atomic operation called <code>getAndAdd()</code> to atomically read the current value of cur and increment its value by 1. Thus, <code>j = cur.getAndAdd(1)</code> has the same semantics as <code>isolated (cur) { j = cur; cur = cur+1;}</code> but is implemented much more efficiently using hardware support on today’s machines.</p> <p>Another example that we studied in the lecture concerns <strong>Atomic Reference</strong> variables, which are reference variables that can be atomically read and modified using methods such as <code>compareAndSet()</code>. If we have an atomic reference <code>ref</code>, then the call to <code>ref.compareAndSet(expected, new)</code> will compare the value of <code>ref</code> to <code>expected</code>, and if they are the same, set the value of <code>ref</code> to <code>new</code> and return <code>true</code>. This all occurs in one atomic operation that cannot be interrupted by any other methods invoked on the <code>ref</code> object. If <code>ref</code> and <code>expected</code> have different values, <code>compareAndSet()</code> will not modify anything and will simply return false.</p> <p>2.4 Optional Reading</p> <ol> <li><a href=https://docs.oracle.com/javase/tutorial/essential/concurrency/atomicvars.html>Tutorial on Atomic Integers in Java</a></li> <li>Article in Java theory and practice series on <a href=https://www.ibm.com/developerworks/library/j-jtp11234/ >Going atomic</a></li> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Primitive_wrapper_class#Atomic_wrapper_classes>Atomic Wrapper Classes in Java</a></li> </ol> <h3 id=25-read-write-isolation>2.5 Read, Write Isolation<a class=headerlink href=#25-read-write-isolation title="Permanent link">&para;</a></h3> <div class=tabbed-set data-tabs=10:2><input checked=checked id=__tabbed_10_1 name=__tabbed_10 type=radio><label for=__tabbed_10_1>Read/Write Isolation</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1>// T1: C.Get(k1), C.Get(k3), C.Get(k5)</span>
<span class=c1>// T2: C.Get(k1), C.Get(k3), C.Get(k5)</span>
<span class=c1>// T3: C.Put(k1)</span>
<span class=n>isolated</span> <span class=p>(</span><span class=n>read</span><span class=p>(</span><span class=n>C</span><span class=p>))</span> <span class=p>{</span>
  <span class=n>V</span> <span class=o>=</span> <span class=n>C</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>k1</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>isolated</span> <span class=p>(</span><span class=n>write</span><span class=p>(</span><span class=n>C</span><span class=p>))</span> <span class=p>{</span>
  <span class=n>C</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>k2</span><span class=p>,</span> <span class=n>v2</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> </div> <input id=__tabbed_10_2 name=__tabbed_10 type=radio><label for=__tabbed_10_2>Read/Write Isolation in LinkedList example</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=n>delete</span> <span class=p>(</span><span class=n>cur</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>isolated</span> <span class=p>(</span><span class=n>write</span><span class=p>(</span><span class=n>cur</span><span class=p>.</span><span class=na>next</span><span class=p>,</span> <span class=n>cur</span><span class=p>.</span><span class=na>prev</span><span class=p>),</span> <span class=n>read</span><span class=p>(</span><span class=n>cur</span><span class=p>))</span> <span class=p>{</span>
    <span class=n>cur</span><span class=p>.</span><span class=na>prev</span><span class=p>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>cur</span><span class=p>.</span><span class=na>next</span><span class=p>;</span>
    <span class=n>cur</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>prev</span> <span class=o>=</span> <span class=n>cur</span><span class=p>.</span><span class=na>prev</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> </div> </div> <p>2.5 Lecture Summary</p> <p>In this lecture we discussed <strong>Read-Write Isolation</strong>, which is a refinement of object-based isolation, and is a higher-level abstraction of the read-write locks studied earlier as part of Unstructured Locks. The main idea behind read-write isolation is to separate read accesses to shared objects from write accesses. This approach enables two threads that only read shared objects to freely execute in parallel since they are not modifying any shared objects. The need for mutual exclusion only arises when one or more threads attempt to enter an isolated section with write access to a shared object.</p> <p>This approach exposes more concurrency than object-based isolation since it allows read accesses to be executed in parallel. In the doubly-linked list example from our lecture, when deleting an object <code>cur</code> from the list by calling <code>delete(cur)</code>, we can replace object-based isolation on <code>cur</code> with read-only isolation, since deleting an object does not modify the object being deleted; only the previous and next objects in the list need to be modified.</p> <p>2.5 Optional Reading</p> <ol> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Readers%E2%80%93writer_lock>Readers-writer lock</a></li> </ol> <h3 id=26-mini-project>2.6 Mini project<a class=headerlink href=#26-mini-project title="Permanent link">&para;</a></h3> <h2 id=week-3>Week 3<a class=headerlink href=#week-3 title="Permanent link">&para;</a></h2> <ul> <li><a href=https://doc.akka.io/docs/akka/2.5/guide/introduction.html#how-to-get-started>Akka</a></li> </ul> <h3 id=31-actors>3.1 Actors<a class=headerlink href=#31-actors title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=n>getAndAdd</span><span class=p>(){</span>
  <span class=n>j</span> <span class=o>=</span> <span class=n>cur</span><span class=p>;</span>
  <span class=n>cur</span> <span class=o>=</span> <span class=n>cur</span> <span class=o>+</span> <span class=n>delta</span><span class=p>;</span>
  <span class=k>return</span> <span class=n>j</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// method doesn&#39;t doing correct isolation</span>
<span class=n>foo</span> <span class=p>()</span> <span class=p>{</span>
  <span class=n>cur</span> <span class=o>=</span> <span class=p>...</span>  
<span class=p>}</span>
</code></pre></div> <p><strong>Actor</strong> (reactive)</p> <ul> <li>Mailbox</li> <li>Method</li> <li>Local State</li> </ul> <p>3.1 Lecture Summary</p> <p>In this lecture, we introduced the Actor Model as an even higher level of concurrency control than locks or isolated sections. One limitation of locks, and even isolated sections, is that, while many threads might correctly control the access to a shared object (e.g., by using object-based isolation) it only takes one thread that accesses the object directly to create subtle and hard-to-discover concurrency errors. The Actor model avoids this problem by forcing all accesses to an object to be isolated by default. The object is part of the local state of an actor, and cannot be accessed directly by any other actor.</p> <p>An Actor consists of a Mailbox, a set of Methods, and Local State. The Actor model is reactive, in that actors can only execute methods in response to messages; these methods can read/write local state and/or send messages to other actors. Thus, the only way to modify an object in a pure actor model is to send messages to the actor that owns that object as part of its local state. In general, messages sent to actors from different actors can be arbitrarily reordered in the system. However, in many actor models, messages sent between the same pair of actors preserve the order in which they are sent.</p> <p>3.1 Optional Reading</p> <ol> <li> <p>Wikipedia article on the <a href=https://en.wikipedia.org/wiki/Actor_model>Actor Model</a></p> </li> <li> <p>Documentation on the <a href=http://doc.akka.io/docs/akka/2.5.3/java/guide/index.html>Akka Actor Library</a> (though Akka is not used in this course, it is a useful library to be aware of if you are interested in using the actor model with Java and Scala applications)</p> </li> </ol> <h3 id=32-actor-examples>3.2 Actor Examples<a class=headerlink href=#32-actor-examples title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1>// print actor</span>
<span class=n>process</span> <span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// like a callback</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>s</span> <span class=o>==</span> <span class=s>&quot;Exit&quot;</span><span class=p>)</span>
    <span class=n>exit</span><span class=p>();</span>
  <span class=k>else</span>
    <span class=n>print</span> <span class=n>s</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p><img alt=actor-example src=../fig/actor-example.png></p> <p>3.2 Lecture Summary</p> <p>In this lecture, we further studied the Actor Model through two simple examples of using actors to implement well-known concurrent programming patterns. The <code>PrintActor</code> in our first example processes simple String messages by printing them. If an <code>EXIT</code> message is sent, then the <code>PrintActor</code> completes its current computation and exits. As a reminder, we assume that messages sent between the same pair of actors preserve the order in which they are sent.</p> <p>In the second example, we created an actor pipeline, in which one actor checks the incoming messages and only forwards the ones that are in lower case. The second actor processes the lowercase messages and only forwards the ones that are of even length. This example illustrates the power of the actor model, as this concurrent system would be much more difficult to implement using threads, for example, since much care would have to be taken on how to implement a shared mailbox for correct and efficient processing by parallel threads.</p> <p>3.2 Optional Reading</p> <ol> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Pipeline_(computing)>Pipeline Parallelism</a>.</li> </ol> <h3 id=33-sieve-of-eratosthenes-algorithm>3.3 Sieve of Eratosthenes Algorithm<a class=headerlink href=#33-sieve-of-eratosthenes-algorithm title="Permanent link">&para;</a></h3> <p><img alt=actor-example src=../fig/sieve-of-eratosthenes.png></p> <p>3.3 Lecture Summary</p> <p>In this lecture, we studied how to use actors to implement a pipelined variant of the Sieve of Eratosthenes algorithm for generating prime numbers. This example illustrates the power of the Actor Model, including dynamic creation of new actors during a computation.</p> <p>To implement the Sieve of Eratosthenes, we first create an actor, Non-Mul-2, that receives (positive) natural numbers as input (up to some limit), and then filters out the numbers that are multiples of 2. After receiving a number that is not a multiple of 2 (in our case, the first would be 3), the Non-Mul-2 actor creates the next actor in the pipeline, Non-Mul-3, with the goal of discarding all the numbers that are multiples of 3. The Non-Mul-2 actor then forwards all non-multiples of 2 to the Non-Mul-3 actor. Similarly, this new actor will create the next actor in the pipeline, Non-Mul-5, with the goal of discarding all the numbers that are multiples of 5. The power of the Actor Model is reflected in the dynamic nature of this problem, where pieces of the computation (new actors) are created dynamically as needed.</p> <p>A Java code sketch for the <code>process()</code> method for an actor responsible for filtering out multiples of the actor's "local prime" in the Sieve of Eratosthenes is as follows:</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kt>void</span> <span class=nf>process</span><span class=p>(</span><span class=kd>final</span> <span class=n>Object</span> <span class=n>msg</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>int</span> <span class=n>candidate</span> <span class=o>=</span> <span class=p>(</span><span class=n>Integer</span><span class=p>)</span> <span class=n>msg</span><span class=p>;</span>
  <span class=c1>// Check if the candidate is a non-multiple of the &quot;local prime&quot;.</span>
  <span class=c1>// For example, localPrime = 2 in the Non-Mul-2 actor</span>
  <span class=kt>boolean</span> <span class=n>nonMul</span> <span class=o>=</span> <span class=p>((</span><span class=n>candidate</span> <span class=o>%</span> <span class=n>localPrime</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>);</span>
  <span class=c1>// nothing needs to be done if nonMul = false</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>nonMul</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>nextActor</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=p>.</span> <span class=p>.</span> <span class=p>.</span> <span class=c1>// create &amp; start new actor with candidate as its local prime</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=n>nextActor</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span> <span class=c1>// forward message to next actor</span>
  <span class=p>}</span>
<span class=p>}</span> <span class=c1>// process</span>
</code></pre></div> <p>3.3 Optional Reading</p> <ol> <li>Wikipedia article on the <a href=https://en.wikipedia.org/wiki/Sieve_of_Eratosthenes>Sieve of Eratosthenes problem</a></li> </ol> <h3 id=34-producer-consumer-problem>3.4 Producer-Consumer Problem<a class=headerlink href=#34-producer-consumer-problem title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1>// consumer thread</span>
<span class=k>while</span> <span class=p>(</span><span class=n>buffer</span><span class=p>.</span><span class=na>empty</span><span class=p>())</span> <span class=p>{</span> <span class=p>}</span>
<span class=c1>// process item removed from buffer</span>
</code></pre></div> <p><img alt=producer-consumer-problem src=../fig/producer-consumer-problem.png></p> <p>3.4 Lecture Summary</p> <p>In this lecture, we studied the producer-consumer pattern in concurrent programming which is used to solve the following classical problem: how can we safely coordinate accesses by multiple producer tasks, <span><span class=MathJax_Preview>P_1</span><script type=math/tex>P_1</script></span>, <span><span class=MathJax_Preview>P_2</span><script type=math/tex>P_2</script></span>, <span><span class=MathJax_Preview>P_3</span><script type=math/tex>P_3</script></span> ... and multiple consumer tasks, <span><span class=MathJax_Preview>C_1</span><script type=math/tex>C_1</script></span>, <span><span class=MathJax_Preview>C_2</span><script type=math/tex>C_2</script></span>, <span><span class=MathJax_Preview>C_3</span><script type=math/tex>C_3</script></span>​, ... to a shared buffer of unbounded size without giving up any concurrency? Part of the reason that this problem can be challenging is that we cannot assume any a priori knowledge about the rate at which different tasks produce and consume items in the buffer. While it is possible to solve this problem by using locks with wait-notify operations or by using object-based isolation, both approaches will require low-level concurrent programming techniques to ensure correctness and maximum performance. Instead, a more elegant solution can be achieved by using actors as follows.</p> <p>The key idea behind any actor-based solution is to think of all objects involved in the concurrent program as actors, which in this case implies that producer tasks, consumer tasks, and the shared buffer should all be implemented as actors. The next step is to establish the communication protocols among the actors. A producer actor can simply send a message to the buffer actor whenever it has an item to produce. The protocol for consumer actors is a bit more complicated. Our solution requires a consumer actor to send a message to the buffer actor whenever it is ready to process an item. Thus, whenever the buffer actor receives a message from a producer, it knows which consumers are ready to process items and can forward the produced item to any one of them. Thus, with the actor model, all concurrent interactions involving the buffer can be encoded in messages, instead of using locks or isolated statements.</p> <h3 id=35-bounded-buffer-problem>3.5 Bounded Buffer Problem<a class=headerlink href=#35-bounded-buffer-problem title="Permanent link">&para;</a></h3> <p><img alt=bounded-buffer-problem src=../fig/bounded-buffer-problem.png></p> <p>3.5 Lecture Summary</p> <p>A major simplification made in the previous lecture was to assume that the shared buffer used by producer and consumer tasks can be unbounded in size. However, in practice, it is also important to consider a more realistic version of the the producer-consumer problem in which the buffer has a bounded size. In fact, the classical producer-consumer problem statement usually assumes a bounded buffer by default. In this lecture, we studied how the actor-based solution to the unbounded buffer case can be extended to support a bounded buffer.</p> <p>The main new challenge with bounding the size of the shared buffer is to ensure that producer tasks are not permitted to send items to the buffer when the buffer is full. Thus, the buffer actor needs to play a master role in the protocol by informing producer actors when they are permitted to send data. This is akin to the role played by the buffer/master actor with respect to consumer actors, even in the unbounded buffer case (in which the consumer actor informed the buffer actor when it is ready to consume an item). Now, the producer actor will only send data when requested to do so by the buffer actor. Though, this actor-based solution appears to be quite simple, it actually solves a classical problem that has been studied in advanced operating system classes for decades.</p> <p>3.5 Optional Reading</p> <p>Wikipedia article on the <a href=https://en.wikipedia.org/wiki/Producer%E2%80%93consumer_problem>Producer-Consumer problem</a></p> <h2 id=week-4>Week 4<a class=headerlink href=#week-4 title="Permanent link">&para;</a></h2> <h3 id=41-optimistic-concurrency>4.1 Optimistic concurrency<a class=headerlink href=#41-optimistic-concurrency title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=kd>class</span> <span class=nc>Integer</span> <span class=p>{</span>
  <span class=n>get</span><span class=p>();</span>
  <span class=n>set</span><span class=p>();</span>
  <span class=n>getAndAdd</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>curr</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>
    <span class=n>next</span> <span class=o>=</span> <span class=n>cur</span> <span class=o>+</span> <span class=n>delta</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>next</span><span class=p>);</span>  <span class=c1>// RACE CONDITION</span>
    <span class=k>return</span> <span class=n>cur</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kd>class</span> <span class=nc>AutomicInteger</span> <span class=p>{</span>
  <span class=n>get</span><span class=p>();</span>
  <span class=n>set</span><span class=p>();</span>
  <span class=n>compareAndSet</span><span class=p>();</span>
  <span class=n>getAndAdd</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>curr</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>
      <span class=n>next</span> <span class=o>=</span> <span class=n>cur</span> <span class=o>+</span> <span class=n>delta</span><span class=p>;</span>
      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>curr</span><span class=p>,</span> <span class=n>next</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>cur</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>4.1 Lecture Summary</p> <p>In this lecture, we studied the optimistic concurrency pattern, which can be used to improve the performance of concurrent data structures. In practice, this pattern is most often used by experts who implement components of concurrent libraries, such as <code>AtomicInteger</code> and <code>ConcurrentHashMap</code>, but it is useful for all programmers to understand the underpinnings of this approach. As an example, we considered how the <code>getAndAdd()</code> method is typically implemented for a shared <code>AtomicInteger</code> object. The basic idea is to allow multiple threads to read the existing value of the shared object (<code>curVal</code>) without any synchronization, and also to compute its new value after the addition (<code>newVal</code>) without synchronization. These computations are performed optimistically under the assumption that no interference will occur with other threads during the period between reading <code>curVal</code> and computing <code>newVal</code>. However, it is necessary for each thread to confirm this assumption by using the <code>compareAndSet()</code> method as follows. (<code>compareAndSet()</code> is used as an important building block for optimistic concurrency because it is implemented very efficiently on many hardware platforms.)</p> <p>The method call <code>A.compareAndSet(curVal, newVal)</code> invoked on <code>AtomicInteger A</code> checks that the value in <code>A</code> still equals <code>curVal</code>, and, if so, updates <code>A</code>’s value to <code>newVal</code> before returning true; otherwise, the method simply returns false without updating <code>A</code>. Further, the <code>compareAndSet()</code> method is guaranteed to be performed atomically, as if it was in an object-based isolated statement with respect to object <code>A</code>. Thus, if two threads, <span><span class=MathJax_Preview>T_1</span><script type=math/tex>T_1</script></span> and <span><span class=MathJax_Preview>T_2</span><script type=math/tex>T_2</script></span> call <code>compareAndSet()</code> with the same <code>curVal</code> that matches <code>A</code>’s current value, only one of them will succeed in updating <code>A</code> with their <code>newVal</code>. Furthermore, each thread will invoke an operation like <code>compareAndSet()</code> repeatedly in a loop until the operation succeeds. This approach is guaranteed to never result in a deadlock since there are no blocking operations. Also, since each call <code>compareAndSet()</code> is guaranteed to eventually succeed, there cannot be a livelock either. In general, so long as the contention on a single shared object like A is not high, the number of calls to <code>compareAndSet()</code> that return false will be very small, and the optimistic concurrency approach can perform much better in practice (but at the cost of more complex code logic) than using locks, isolation, or actors.</p> <p>4.1 Optional Reading</p> <ol> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Optimistic_concurrency_control>Optimistic concurrency control</a></li> <li><a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/atomic/AtomicInteger.html>Documentation on Java’s AtomicInteger class</a></li> </ol> <h3 id=42-concurrent-queue>4.2 Concurrent Queue<a class=headerlink href=#42-concurrent-queue title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=n>Queue</span> <span class=p>{</span>
  <span class=n>enQ</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>tail</span><span class=p>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>
    <span class=n>tail</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>deQ</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Q</span><span class=p>.</span><span class=na>empty</span><span class=p>)</span> <span class=p>{</span><span class=c1>// exception }</span>
    <span class=n>r</span> <span class=o>=</span> <span class=n>head</span><span class=p>;</span>
    <span class=n>head</span> <span class=o>=</span> <span class=n>head</span><span class=p>.</span><span class=na>next</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>r</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=n>Queue</span> <span class=p>{</span>
  <span class=n>enQ</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>tail</span><span class=p>.</span><span class=na>next</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>continue</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=n>deQ</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Q</span><span class=p>.</span><span class=na>empty</span><span class=p>)</span> <span class=p>{</span><span class=c1>// exception }</span>
    <span class=n>r</span> <span class=o>=</span> <span class=n>head</span><span class=p>;</span>
    <span class=n>head</span> <span class=o>=</span> <span class=n>head</span><span class=p>.</span><span class=na>next</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>r</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>4.2 Lecture Summary</p> <p>In this lecture, we studied concurrent queues, an extension of the popular queue data structure to support concurrent accesses. The most common operations on a queue are <code>enq(x)</code>, which enqueues object <code>x</code> at the end (<code>tail</code>) of the queue, and <code>deq()</code> which removes and returns the item at the start (<code>head</code>) of the queue. A correct implementation of a concurrent queue must ensure that calls to <code>enq()</code> and <code>deq()</code> maintain the correct semantics, even if the calls are invoked concurrently from different threads. While it is always possible to use locks, isolation, or actors to obtain correct but less efficient implementations of a concurrent queue, this lecture illustrated how an expert might implement a more efficient concurrent queue using the optimistic concurrency pattern.</p> <p>A common approach for such an implementation is to replace an object reference like <code>tail</code> by an <code>AtomicReference</code>. Since the <code>compareAndSet()</code> method can also be invoked on <code>AtomicReference</code> objects, we can use it to support (for example) concurrent calls to <code>enq()</code> by identifying which calls to <code>compareAndSet()</code> succeeded, and repeating the calls that failed. This provides the basic recipe for more efficient implementations of <code>enq()</code> and <code>deq()</code>, as are typically developed by concurrency experts. A popular implementation of concurrent queues available in Java is <code>java.util.concurrent.ConcurrentLinkedQueue</code>.</p> <p>4.2 Optional Reading</p> <ol> <li><a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/atomic/AtomicReference.html>Documentation on Java’s AtomicReference class</a></li> <li><a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentLinkedQueue.html>Documentation on Java's ConcurrentLinkedQueue class</a></li> </ol> <h3 id=43-linearizability>4.3 Linearizability<a class=headerlink href=#43-linearizability title="Permanent link">&para;</a></h3> <p>4.3 Lecture Summary</p> <p>In this lecture, we studied an important correctness property of concurrent objects that is called Linearizability. A concurrent object is a data structure that is designed to support operations in parallel by multiple threads. The key question answered by <strong>linearizability</strong> is what return values are permissible when multiple threads perform these operations in parallel, taking into account what we know about the expected return values from those operations when they are performed sequentially. As an example, we considered two threads, <span><span class=MathJax_Preview>T_1</span><script type=math/tex>T_1</script></span> and <span><span class=MathJax_Preview>T_2</span><script type=math/tex>T_2</script></span>, performing <code>enq(x)</code> and <code>enq(y)</code> operations in parallel on a shared concurrent queue data structure, and considered what values can be returned by a <code>deq()</code> operation performed by <span><span class=MathJax_Preview>T_2</span><script type=math/tex>T_2</script></span> after the call to <code>enq(y)</code>. From the viewpoint of linearizability, it is possible for the <code>deq()</code> operation to return item <code>x</code> or item <code>y</code>.</p> <p>One way to look at the definition of linearizability is as though you are a lawyer attempting to "defend" a friend who implemented a concurrent data structure, and that all you need to do to prove that your friend is "not guilty" (did not write a buggy implementation) is to show one scenario in which all the operations return values that would be consistent with a sequential execution by identifying logical moments of time at which the operations can be claimed to have taken effect. Thus, if <code>deq()</code> returned item <code>x</code> or item <code>y</code> you can claim that either scenario is plausible because we can reasonably assume that <code>enq(x)</code> took effect before <code>enq(y)</code>, or vice versa. However, there is absolutely no plausible scenario in which the call to <code>deq()</code> can correctly return a code/exception to indicate that the queue is empty since at least <code>enq(y)</code> must have taken effect before the call to <code>deq()</code>. Thus, a goal for any implementation of a concurrent data structure is to ensure that all its executions are linearizable by using whatever combination of constructs (e.g., locks, isolated, actors, optimistic concurrency) is deemed appropriate to ensure correctness while giving the maximum performance.</p> <p>4.3 Optional Reading</p> <ol> <li><a href=https://en.wikipedia.org/wiki/Linearizability>Wikipedia article on the Linearizability</a></li> </ol> <h3 id=44-concurrenthashmap>4.4 ConcurrentHashMap<a class=headerlink href=#44-concurrenthashmap title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ConcurrentHashMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ConcurrentHashMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
<span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ConcurrentHashMap</span><span class=p>.</span><span class=na>putIfAbsent</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
<span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ConcurrentHashMap</span><span class=p>.</span><span class=na>clear</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
<span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ConcurrentHashMap</span><span class=p>.</span><span class=na>putAll</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>

<span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ConcurrentLinkedQueue</span>
<span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ConcurrentSkipListSet</span>
</code></pre></div> <p>4.4 Lecture Summary</p> <p>In this lecture, we studied the <code>ConcurrentHashMap</code> data structure, which is available as part of the <code>java.util.concurrent</code> standard library in Java. A <code>ConcurrentHashMap</code> instance, <code>chm</code>, implements the Map interface, including the <code>get(key)</code> and <code>put(key, value)</code> operations. It also implements additional operations specified in the <code>ConcurrentMap</code> interface (which in turn extends the <code>Map</code> interface); one such operation is <code>putIfAbsent(key, value)</code>. The motivation for using <code>putIfAbsent()</code> is to ensure that only one instance of key is inserted in <code>chm</code>, even if multiple threads attempt to insert the same key in parallel. Thus, the semantics of calls to <code>get()</code>, <code>put()</code>, and <code>putIfAbsent()</code> can all be specified by the theory of linearizability studied earlier. However, it is worth noting that there are also some aggregate operations, such as <code>clear()</code> and <code>putAll()</code>, that cannot safely be performed in parallel with <code>put()</code>, <code>get()</code> and <code>putIfAbsent()</code>.</p> <p>Motivated by the large number of concurrent data structures available in the <code>java.util.concurrent</code> library, this lecture advocates that, when possible, you use libraries such as <code>ConcurrentHashMap</code> rather than try to implement your own version.</p> <p>4.4 Optional Reading</p> <ol> <li><a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentHashMap.html>Documentation on Java’s ConcurrentHashMap class</a></li> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Java_ConcurrentMap>Java’s ConcurrentMap interface</a></li> </ol> <h3 id=45-concurrent-minimum-spanning-tree-algorithm>4.5 Concurrent Minimum Spanning Tree Algorithm<a class=headerlink href=#45-concurrent-minimum-spanning-tree-algorithm title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=c1>// Boruvka MST</span>
<span class=c1>// L is the vertices set (ConcurrentLinkedQueue)</span>
<span class=k>while</span> <span class=p>(</span><span class=n>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>n1</span> <span class=o>=</span> <span class=n>remove</span><span class=p>(</span><span class=n>L</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>tryLock</span><span class=p>(</span><span class=n>n1</span><span class=p>))</span> <span class=p>{</span> <span class=k>continue</span><span class=p>;</span> <span class=p>}</span>
  <span class=n>e</span> <span class=o>=</span> <span class=n>getMinEdge</span><span class=p>(</span><span class=n>M</span><span class=p>);</span>
  <span class=n>n2</span> <span class=o>=</span> <span class=n>getNeighbor</span><span class=p>(</span><span class=n>n1</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>tryLock</span><span class=p>(</span><span class=n>n2</span><span class=p>))</span> <span class=p>{</span>
    <span class=c1>// fixup</span>
    <span class=k>continue</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>n3</span> <span class=o>=</span> <span class=n>merge</span><span class=p>(</span><span class=n>n1</span><span class=p>,</span> <span class=n>n2</span><span class=p>);</span>
  <span class=n>remove</span><span class=p>(</span><span class=n>n2</span><span class=p>);</span>
  <span class=n>insert</span><span class=p>(</span><span class=n>n3</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>4.5 Lecture Summary</p> <p>In this lecture, we discussed how to apply concepts learned in this course to design a concurrent algorithm that solves the problem of finding a minimum-cost spanning tree (MST) for an undirected graph. It is well known that undirected graphs can be used to represent all kinds of networks, including roadways, train routes, and air routes. A spanning tree is a data structure that contains a subset of edges from the graph which connect all nodes in the graph without including a cycle. The cost of a spanning tree is computed as the sum of the weights of all edges in the tree.</p> <p>The concurrent algorithm studied in this lecture builds on a well-known sequential algorithm that iteratively performs edge contraction operations, such that given a node <code>N1</code> in the graph, <code>GetMinEdge(N1)</code> returns an edge adjacent to <code>N1</code> with minimum cost for inclusion in the MST. If the minimum-cost edge is (<code>N1</code>,<code>N2</code>), the algorithm will attempt to combine nodes <code>N1</code> and <code>N2</code> in the graph and replace the pair by a single node, <code>N3</code>. To perform edge contractions in parallel, we have to look out for the case when two threads may collide on the same vertex. For example, even if two threads started with vertices <code>A</code> and <code>D</code>, they may both end up with <code>C</code> as the neighbor with the minimum cost edge. We must avoid a situation in which the algorithm tries to combine both <code>A</code> and <code>C</code> and <code>D</code> and <code>C</code>. One possible approach is to use unstructured locks with calls to <code>tryLock()</code> to perform the combining safely, but without creating the possibility of deadlock or livelock situations. A key challenge with calling <code>tryLock()</code> is that some fix-up is required if the call returns false. Finally, it also helps to use a concurrent queue data structure to keep track of nodes that are available for processing.</p> <p>4.5 Optional Reading</p> <ol> <li>Wikipedia article on <a href=https://en.wikipedia.org/wiki/Bor%C5%AFvka%27s_algorithm>Borvka’s algorithm</a> for finding a minimum cost spanning tree of an undirected graph</li> </ol> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../applied-scrum-for-agile/notes/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Applied Scrum for Agile Project Management" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Applied Scrum for Agile Project Management </div> </div> </a> <a href=../../java-collections/notes/ class="md-footer__link md-footer__link--next" aria-label="Next: Java Collections" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Java Collections </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2020 Rui Han </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script> <script src=../../../assets/javascripts/bundle.82b56eb2.min.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>